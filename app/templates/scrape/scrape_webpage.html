{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
      <h1>Scrape Results</h1>
      url: {{ url }}

      {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
      {% endif %}

      <!-- Scraping Spinner -->
      <div id="scrapingSpinner" class="text-center" style="display: none;">
          <div class="spinner-border text-primary" role="status">
              <span class="sr-only">Loading...</span>
          </div>
          <p class="mt-2">Scraping content...</p>
      </div>

      {% if tables %}
            {% for index, table in tables.items() %}
            <div class="card mb-4">
                <div class="card-header">
                    Table {{ index + 1 }}
                    <form action="{{ url_for('main.about') }}" method="POST" class="float-right schema-form">
                        <input type="hidden" name="table_html" value="{{ original_tables[index] }}">
                        <button type="submit" class="btn btn-sm btn-primary generate-schema-btn">Generate Schema</button>
                    </form>
                </div>
                <div class="card-body">
                    {{ table | safe }}
                </div>
            </div>
            {% endfor %}

            <!-- New Scrape button -->
            <div class="mt-4">
                <button onclick="newScrape()" class="btn btn-primary">New Scrape</button>
            </div>
      {% endif %}
    </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('scrapingSpinner').style.display = 'block';

    const url = url;

    fetch("{{ url_for('scrape.scrape') }}", {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(html => {
        // Replace the current page content with the new HTML
        document.documentElement.innerHTML = html;
        // Re-run scripts since we replaced the entire content
        const scripts = document.getElementsByTagName('script');
        for (let script of scripts) {
            eval(script.innerHTML);
        }
        // Update the URL without reloading the page
        history.pushState({}, '', "{{ url_for('scrape.scrape_form') }}");
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error occurred while scraping');
        // Reset the button state
        submitButton.disabled = false;
        submitButton.innerHTML = 'Scrape Tables';
        // Hide the spinner
        document.getElementById('scrapingSpinner').style.display = 'none';
    });
  });
</script>

{% endblock %} 